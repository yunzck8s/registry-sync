# Registry Sync 用户手册

<div align="center">

**版本：v0.0.1**

企业级 Docker/Harbor 镜像同步管理平台

</div>

---

## 📋 目录

- [系统简介](#系统简介)
- [快速开始](#快速开始)
- [功能模块](#功能模块)
  - [1. 仪表盘](#1-仪表盘)
  - [2. Registry 管理](#2-registry-管理)
  - [3. 任务管理](#3-任务管理)
  - [4. 执行历史](#4-执行历史)
  - [5. 通知管理](#5-通知管理)
- [操作指南](#操作指南)
  - [添加 Registry](#添加-registry)
  - [创建同步任务](#创建同步任务)
  - [执行和监控任务](#执行和监控任务)
  - [配置通知](#配置通知)
- [高级功能](#高级功能)
  - [Tag 过滤规则](#tag-过滤规则)
  - [多架构镜像同步](#多架构镜像同步)
  - [整个项目同步](#整个项目同步)
  - [定时任务设置](#定时任务设置)
- [常见问题](#常见问题)
- [最佳实践](#最佳实践)

---

## 系统简介

Registry Sync 是一个企业级容器镜像同步管理平台，帮助您轻松实现跨 Registry 的镜像同步。

### 核心功能

- **镜像同步** - 支持 Docker Hub、Harbor、阿里云 ACR 等主流镜像仓库
- **多架构支持** - 自动识别并同步多架构镜像（amd64/arm64/arm 等）
- **智能过滤** - 使用正则表达式精确匹配需要的镜像版本
- **定时任务** - 设置 Cron 定时任务，自动执行同步
- **实时通知** - 企业微信、钉钉通知，及时获知同步结果
- **进度追踪** - 实时查看同步进度和详细日志

### 适用场景

- **跨云迁移** - 从 Docker Hub 迁移到阿里云/腾讯云
- **内网同步** - 从公网 Registry 同步到内网 Harbor
- **灾备同步** - 定期备份镜像到备用 Registry
- **多区域分发** - 同步镜像到多个区域的 Registry

---

## 快速开始

### 访问系统

在浏览器中打开系统地址：

```
http://your-server-ip:8080
```

或使用域名访问（如果已配置）

### 界面布局

系统采用左侧菜单 + 右侧内容的布局：

**左侧菜单**
- 仪表盘 - 查看统计信息
- Registry 管理 - 管理镜像仓库
- 任务管理 - 创建和管理同步任务
- 执行历史 - 查看同步记录和日志
- 通知管理 - 配置通知渠道

**右侧内容区**
- 显示对应模块的详细内容
- 提供操作按钮和表单

---

## 功能模块

### 1. 仪表盘

**功能说明**

仪表盘提供系统的整体概览，包括：

- **统计卡片**
  - 总任务数 / 启用任务数
  - 总执行记录
  - 运行中的任务
  - 成功 / 失败次数
  - Registry 总数

- **最近执行记录**
  - 显示最近 10 条执行记录
  - 实时更新执行状态
  - 快速跳转到详细日志

**使用提示**
- 仪表盘会自动刷新数据
- 点击卡片可跳转到对应模块
- 点击执行记录可查看详细日志

---

### 2. Registry 管理

**功能说明**

管理所有的镜像仓库配置，包括 Docker Hub、Harbor、阿里云 ACR 等。

**主要操作**
- 添加 Registry
- 编辑 Registry 配置
- 删除 Registry
- 测试连接
- 浏览项目和仓库

**状态说明**
- **已启用** - 可以在任务中使用
- **已禁用** - 暂时不可用，但保留配置

---

### 3. 任务管理

**功能说明**

创建和管理镜像同步任务，支持一次性任务和定时任务。

**任务配置项**
- 基础信息（名称、启用状态）
- 源配置（Registry、项目、仓库）
- 目标配置（Registry、项目、仓库）
- Tag 过滤规则（包含、排除、保留最新 N 个）
- 架构选择（amd64/arm64 等）
- 定时任务（Cron 表达式）
- 通知配置（渠道、条件）

**任务操作**
- 立即运行 - 手动触发任务执行
- 停止 - 停止正在运行的任务
- 编辑 - 修改任务配置
- 删除 - 删除任务（不可恢复）
- 启用/禁用 - 切换任务状态

---

### 4. 执行历史

**功能说明**

查看所有任务的执行记录，包括正在运行、成功和失败的记录。

**信息展示**
- 执行时间和耗时
- 执行状态（运行中/成功/失败）
- 进度条和百分比
- 同步数据统计（总 blob 数、已同步、跳过、失败）
- 关联的任务名称

**操作功能**
- 查看详细日志 - 查看完整同步过程
- 状态筛选 - 只查看特定状态的记录
- 搜索 - 按任务名称搜索

---

### 5. 通知管理

**功能说明**

配置企业微信、钉钉等通知渠道，在任务完成后自动发送通知。

**支持的通知类型**
- 企业微信群机器人
- 钉钉群机器人

**通知内容**
- 任务名称
- 执行状态（成功/失败）
- 执行耗时
- 数据统计（总计、成功、跳过）
- 执行时间

**操作功能**
- 添加通知渠道
- 编辑渠道配置
- 删除渠道
- 测试发送 - 验证配置是否正确
- 启用/禁用渠道

---

## 操作指南

### 添加 Registry

**步骤 1：进入 Registry 管理**

点击左侧菜单的 **Registry 管理**

**步骤 2：点击添加按钮**

点击右上角的 **添加 Registry** 按钮

**步骤 3：填写配置信息**

| 字段 | 说明 | 示例 |
|------|------|------|
| 名称 | 自定义名称，方便识别 | `Docker Hub`、`Harbor 生产环境` |
| URL | Registry 的完整地址 | `https://registry-1.docker.io` |
| 用户名 | 登录用户名 | `your-username` |
| 密码 | 登录密码或 Token | `your-password-or-token` |
| 启用 | 是否立即启用此 Registry | 勾选 |

**常见 Registry URL**

| Registry 类型 | URL 格式 |
|---------------|----------|
| Docker Hub | `https://registry-1.docker.io` |
| Harbor | `https://harbor.example.com` |
| 阿里云 ACR | `https://registry.cn-hangzhou.aliyuncs.com` |
| 腾讯云 TCR | `https://ccr.ccs.tencentyun.com` |
| 华为云 SWR | `https://swr.cn-north-4.myhuaweicloud.com` |

**步骤 4：测试连接**

点击 **测试连接** 按钮，验证配置是否正确

- ✅ 成功：显示绿色提示，可以保存
- ❌ 失败：显示错误信息，检查配置

**步骤 5：保存配置**

点击 **确定** 按钮保存 Registry 配置

**重要提示**

1. **Docker Hub**
   - 免费账户有限流限制（100 次/6 小时）
   - 建议使用 Personal Access Token 而非密码
   - Token 获取：Docker Hub → Account Settings → Security → New Access Token

2. **Harbor**
   - 确保用户有目标项目的读写权限
   - 私有项目需要相应的访问权限

3. **密码安全**
   - 编辑时密码字段留空表示不修改原密码
   - 密码不会在界面上显示

---

### 创建同步任务

**步骤 1：进入任务管理**

点击左侧菜单的 **任务管理**

**步骤 2：点击创建按钮**

点击右上角的 **创建任务** 按钮

**步骤 3：填写基础配置**

| 字段 | 说明 | 示例 |
|------|------|------|
| 任务名称 | 描述性名称，方便识别 | `同步 Nginx 到生产环境` |
| 启用 | 是否立即启用此任务 | 勾选（启用后定时任务才会生效） |

**步骤 4：配置源 Registry**

| 字段 | 说明 | 示例 |
|------|------|------|
| 源 Registry | 选择已配置的 Registry | `Docker Hub` |
| 项目 | 选择项目或命名空间 | `library` |
| 仓库 | 指定仓库名，留空则同步整个项目 | `nginx` |

**源配置说明**
- **留空仓库**：同步整个项目下的所有仓库
- **指定仓库**：只同步指定的单个仓库
- **项目/命名空间**：
  - Docker Hub：使用 `library`（官方镜像）或用户名
  - Harbor：项目名称

**步骤 5：配置目标 Registry**

| 字段 | 说明 | 示例 |
|------|------|------|
| 目标 Registry | 选择目标 Registry | `Harbor 生产环境` |
| 项目 | 输入或选择项目名 | `prod` |
| 仓库 | 自定义仓库名，留空则使用源仓库名 | 留空或 `nginx` |

**目标配置说明**
- **项目支持多选**：可以同步到多个项目
- **自动创建仓库**：如果目标仓库不存在，会自动创建
- **不会自动创建项目**：请确保目标项目已存在

**步骤 6：设置 Tag 过滤规则**

| 字段 | 说明 | 示例 |
|------|------|------|
| 包含 Tag（正则） | 匹配要同步的 Tag | `^1\.2[0-9]\..*` |
| 排除 Tag（正则） | 排除不需要的 Tag | `.*-alpine,.*-debug` |
| 保留最新 N 个 | 只同步最新的 N 个 Tag | `10`（0 表示不限制） |

**过滤规则说明**
- **多个正则表达式**：用逗号分隔
- **匹配顺序**：先包含，再排除，最后保留最新 N 个
- **留空**：表示不过滤，同步所有 Tag

**常用正则表达式示例**

```bash
# 只同步 latest 标签
^latest$

# 同步所有 1.x 版本
^1\..*

# 同步稳定版本（排除 beta、rc、alpha）
.*
排除：.*(beta|rc|alpha).*

# 只同步特定版本范围
^1\.(2[0-9]|[3-9][0-9])\..*

# 排除 alpine 和 slim 变体
排除：.*(alpine|slim).*
```

**步骤 7：选择架构**

勾选需要同步的架构：
- ☑ amd64（Intel/AMD 64位）
- ☑ arm64（ARM 64位，如 Apple M1/M2）
- ☐ arm/v7（ARM 32位）
- ☐ 386（Intel/AMD 32位）

**架构选择说明**
- **留空**：同步所有架构
- **多选**：只同步选中的架构
- **多架构镜像**：系统会自动识别并正确处理

**步骤 8：配置定时任务**

选择定时执行策略：

| 选项 | Cron 表达式 | 说明 |
|------|-------------|------|
| 不启用定时任务 | - | 仅手动执行 |
| 每小时执行 | `0 * * * *` | 每小时的整点 |
| 每天凌晨2点 | `0 2 * * *` | 每天凌晨 2:00 |
| 每天中午12点 | `0 12 * * *` | 每天中午 12:00 |
| 每周一凌晨2点 | `0 2 * * 1` | 每周一凌晨 2:00 |
| 每月1号凌晨2点 | `0 2 1 * *` | 每月 1 号凌晨 2:00 |
| 每6小时执行 | `0 */6 * * *` | 每 6 小时执行一次 |
| 每12小时执行 | `0 */12 * * *` | 每 12 小时执行一次 |
| 自定义 | 手动输入 | 自定义 Cron 表达式 |

**自定义 Cron 表达式格式**

```
格式：分 时 日 月 星期

示例：
0 2 * * *         # 每天凌晨 2 点
0 */4 * * *       # 每 4 小时
30 8 * * 1-5      # 工作日早上 8:30
0 0 1,15 * *      # 每月 1 号和 15 号零点
```

**步骤 9：配置通知**

| 字段 | 说明 |
|------|------|
| 启用通知 | 开关，是否发送通知 |
| 通知条件 | **全部发送**（成功+失败）或 **仅失败时发送** |
| 通知渠道 | 多选，选择已配置的通知渠道 |

**通知配置提示**
- 定时任务频繁执行会产生大量通知
- 建议定时任务选择"仅失败时发送"
- 一次性任务可以选择"全部发送"

**步骤 10：保存任务**

点击 **确定** 按钮保存任务

**任务创建完成后**
- 如果启用了任务，定时任务会自动执行
- 可以点击"立即运行"手动触发一次
- 在执行历史中查看同步进度

---

### 执行和监控任务

#### 手动执行任务

**方式 1：在任务列表中执行**

1. 进入 **任务管理** 页面
2. 找到要执行的任务
3. 点击 **立即运行** 按钮
4. 自动跳转到执行历史页面

**方式 2：在任务详情中执行**

1. 点击任务名称进入详情
2. 点击 **立即运行** 按钮

#### 查看执行进度

**实时进度展示**

进入 **执行历史** 页面，可以看到：

- **进度条** - 可视化显示完成百分比
- **状态标识** - 运行中/成功/失败
- **数据统计**
  - 总 blob 数
  - 已同步 blob 数
  - 跳过的 blob 数
  - 失败的 blob 数
- **执行时间** - 开始时间和耗时

**进度自动刷新**

执行历史页面会自动刷新，无需手动刷新浏览器

#### 查看详细日志

**操作步骤**

1. 进入 **执行历史** 页面
2. 找到要查看的执行记录
3. 点击 **查看日志** 按钮
4. 在弹出窗口中查看完整日志

**日志内容包括**

- 任务开始时间
- 每个 tag 的同步过程
- 每个 blob 的传输状态
- 成功/失败的详细信息
- 任务完成时间和总结

**日志示例**

```
开始执行任务: 同步 Nginx
源仓库: docker.io/library/nginx
目标仓库: harbor.example.com/prod/nginx

[1/5] 同步 tag: nginx:1.25.3
检测到多架构镜像，包含 2 个平台
同步平台 linux/amd64 的 manifest
  复制 blob: sha256:12ab34cd... (50.5 MB) - 成功
  复制 blob: sha256:56ef78gh... (23.1 MB) - 成功
  ...
平台 linux/amd64 manifest 同步完成
同步平台 linux/arm64 的 manifest
  ...
tag 1.25.3 同步完成

全部完成！共同步 16 个 blob，跳过 0 个，失败 0 个
```

#### 停止正在运行的任务

**操作步骤**

1. 在任务列表或执行历史中找到运行中的任务
2. 点击 **停止** 按钮
3. 确认停止操作

**注意事项**
- 只能停止"运行中"状态的任务
- 停止后的任务状态会变为"失败"
- 已传输的 blob 不会回滚

---

### 配置通知

#### 添加企业微信通知

**步骤 1：创建企业微信群机器人**

1. 在企业微信群中，右上角 → 群设置 → 群机器人
2. 点击 **添加机器人**
3. 设置机器人名称（如：Registry Sync 通知）
4. 复制生成的 Webhook URL

**步骤 2：在系统中添加通知渠道**

1. 进入 **通知管理** 页面
2. 点击 **添加通知渠道** 按钮
3. 填写配置：
   - **名称**：`企业微信-运维群`
   - **类型**：选择 `企业微信`
   - **Webhook URL**：粘贴复制的 URL
   - **启用**：勾选
4. 点击 **测试发送** 按钮
5. 检查企业微信群是否收到测试消息
6. 点击 **确定** 保存

#### 添加钉钉通知

**步骤 1：创建钉钉群机器人**

1. 在钉钉群中，右上角 → 智能群助手 → 添加机器人
2. 选择 **自定义** 类型
3. 设置机器人名称和头像
4. **安全设置**：
   - 推荐选择"加签"方式
   - 或选择"自定义关键词"，输入：`Registry Sync`
5. 复制生成的 Webhook URL
6. 如果选择加签，还需复制 Secret

**步骤 2：在系统中添加通知渠道**

1. 进入 **通知管理** 页面
2. 点击 **添加通知渠道** 按钮
3. 填写配置：
   - **名称**：`钉钉-技术群`
   - **类型**：选择 `钉钉`
   - **Webhook URL**：粘贴复制的 URL
   - **Secret**：如果使用加签，填写 Secret（可选）
   - **启用**：勾选
4. 点击 **测试发送** 按钮
5. 检查钉钉群是否收到测试消息
6. 点击 **确定** 保存

#### 通知消息示例

**成功通知**

```markdown
### 镜像同步任务通知

> 任务名称：同步 Nginx 到生产
> 执行状态：成功
> 执行耗时：3分15秒
>
> 数据统计
> - 总计：16 个 blob
> - 成功：16 个
> - 跳过：0 个

2025-11-27 18:30:00
```

**失败通知**

```markdown
### 镜像同步任务通知

> 任务名称：同步 Redis 到测试
> 执行状态：失败
> 执行耗时：1分08秒
>
> 数据统计
> - 总计：20 个 blob
> - 成功：15 个
> - 失败：5 个

2025-11-27 18:30:00
```

#### 在任务中使用通知

创建或编辑任务时：

1. 展开 **通知配置** 部分
2. 开启 **启用通知** 开关
3. 选择 **通知条件**：
   - **全部发送**：成功和失败都发送
   - **仅失败时发送**：只有失败时发送
4. 选择 **通知渠道**（可多选）
5. 保存任务

**通知配置建议**
- 测试任务：全部发送
- 生产定时任务：仅失败时发送
- 一次性同步：全部发送

---

## 高级功能

### Tag 过滤规则

#### 包含规则（Include）

使用正则表达式匹配要同步的 Tag

**示例 1：只同步特定标签**

```
^latest$
```
只同步 `latest` 标签

**示例 2：同步版本范围**

```
^1\.2[0-9]\..*
```
同步所有 1.20.x - 1.29.x 版本

**示例 3：同步多个特定版本**

```
^(1\.25\.3|1\.24\.5|latest)$
```
只同步 1.25.3、1.24.5 和 latest

**示例 4：同步稳定版本**

```
^[0-9]+\.[0-9]+\.[0-9]+$
```
只同步标准版本号（如 1.2.3），排除 beta/rc 等

#### 排除规则（Exclude）

使用正则表达式排除不需要的 Tag

**示例 1：排除测试版本**

```
.*(beta|rc|alpha).*
```
排除包含 beta、rc、alpha 的版本

**示例 2：排除特定变体**

```
.*(alpine|slim|debug).*
```
排除 alpine、slim、debug 变体

**示例 3：排除旧版本**

```
^0\..*
```
排除所有 0.x 版本

**示例 4：排除特定日期**

```
.*-202[0-3].*
```
排除 2020-2023 年的版本

#### 保留最新 N 个

在满足包含和排除规则后，只保留最新的 N 个 Tag

**示例**

- 设置为 `10`：只同步最新 10 个版本
- 设置为 `0`：不限制，同步所有匹配的版本

**排序规则**

系统会根据镜像创建时间排序，而不是 Tag 名称

#### 组合使用示例

**场景 1：只同步生产稳定版本**

```
包含：^[0-9]+\.[0-9]+\.[0-9]+$
排除：.*(beta|rc|alpha).*
保留最新：10
```

**场景 2：同步最新的 1.x 和 2.x 版本**

```
包含：^[1-2]\..*
排除：.*(alpine|debug).*
保留最新：20
```

**场景 3：只同步指定版本**

```
包含：^(latest|stable|1\.25\..*)$
排除：（留空）
保留最新：0
```

---

### 多架构镜像同步

#### 什么是多架构镜像

多架构镜像是指一个镜像标签（如 `nginx:latest`）包含多个平台的镜像，例如：
- `linux/amd64` - Intel/AMD 64位处理器
- `linux/arm64` - ARM 64位处理器（如 Apple M1/M2）
- `linux/arm/v7` - ARM 32位处理器

#### 系统如何处理多架构镜像

1. **自动检测**
   - 系统会自动识别 Manifest List（多架构索引）
   - 在日志中显示：`检测到多架构镜像，包含 N 个平台`

2. **分平台同步**
   - 依次同步每个架构的 manifest 和 blobs
   - 每个架构的进度独立显示

3. **完整性保证**
   - 只有所有选中的架构都同步成功，才上传 Manifest List
   - 如果某个架构失败，会跳过整个 tag

#### 架构选择建议

**生产环境**
```
☑ linux/amd64    # 服务器主流架构
☑ linux/arm64    # ARM 服务器（如 AWS Graviton）
☐ linux/arm/v7   # 通常不需要
☐ linux/386      # 已过时
```

**开发环境**
```
☑ linux/amd64    # Intel 笔记本
☑ linux/arm64    # Apple M1/M2
```

**嵌入式设备**
```
☑ linux/arm64    # 64位 ARM 设备
☑ linux/arm/v7   # 32位 ARM 设备（如树莓派）
```

#### 日志示例

```
[1/1] 同步 tag: nginx:latest
检测到多架构镜像 (manifest list)，包含 2 个平台

同步平台 linux/arm64 的 manifest
  复制 blob: sha256:12ab... (45.2 MB) - 成功
  复制 blob: sha256:34cd... (23.1 MB) - 成功
  复制 blob: sha256:56ef... (12.5 MB) - 成功
平台 linux/arm64 manifest 同步完成

同步平台 linux/amd64 的 manifest
  复制 blob: sha256:78gh... (47.8 MB) - 成功
  复制 blob: sha256:90ij... (24.3 MB) - 成功
  复制 blob: sha256:12kl... (13.1 MB) - 成功
平台 linux/amd64 manifest 同步完成

tag latest 同步完成
```

---

### 整个项目同步

#### 什么是项目同步

不指定具体仓库名，系统会自动同步整个项目（或命名空间）下的所有仓库。

#### 配置方法

在创建任务时：
- **源仓库**：留空
- **目标仓库**：留空

系统会自动：
1. 列出源项目下的所有仓库
2. 对每个仓库应用 Tag 过滤规则
3. 依次同步到目标项目

#### 使用场景

**场景 1：整体迁移**

从 Docker Hub 迁移整个命名空间到私有 Harbor：

```
源：
  Registry: Docker Hub
  项目: mycompany
  仓库: （留空）

目标：
  Registry: Harbor
  项目: mycompany
  仓库: （留空）
```

**场景 2：备份整个项目**

定期备份生产项目到灾备 Registry：

```
源：
  Registry: Harbor 生产
  项目: production
  仓库: （留空）

目标：
  Registry: Harbor 备份
  项目: production-backup
  仓库: （留空）

定时任务: 每天凌晨 2 点
```

#### 注意事项

1. **项目必须存在**
   - 目标项目必须提前创建
   - 系统不会自动创建项目

2. **仓库会自动创建**
   - 目标仓库不存在时会自动创建
   - 使用源仓库的名称

3. **权限要求**
   - 源 Registry 需要整个项目的读权限
   - 目标 Registry 需要项目的写权限

4. **执行时间**
   - 整个项目同步可能需要较长时间
   - 建议在非高峰时段执行
   - 可以配置定时任务在凌晨执行

#### 日志示例

```
开始执行任务: 备份生产环境镜像
源项目: harbor-prod/production
目标项目: harbor-backup/production-backup

发现 5 个仓库需要同步

[1/5] 同步仓库: nginx
  [1/3] 同步 tag: nginx:1.25.3
  [2/3] 同步 tag: nginx:1.24.5
  [3/3] 同步 tag: nginx:latest
仓库 nginx 同步完成

[2/5] 同步仓库: redis
  [1/2] 同步 tag: redis:7.2.3
  [2/2] 同步 tag: redis:latest
仓库 redis 同步完成

...

全部完成！共 5 个仓库，15 个 tag，128 个 blob
```

---

### 定时任务设置

#### Cron 表达式格式

```
格式：分 时 日 月 星期

字段说明：
  分   - 0-59
  时   - 0-23
  日   - 1-31
  月   - 1-12
  星期 - 0-7（0 和 7 都表示周日）

特殊字符：
  *    - 任意值
  ,    - 列表（如 1,3,5）
  -    - 范围（如 1-5）
  /    - 间隔（如 */5 表示每 5 个单位）
```

#### 常用表达式

**每小时**
```
0 * * * *        # 每小时整点
30 * * * *       # 每小时的 30 分
*/30 * * * *     # 每 30 分钟
```

**每天**
```
0 2 * * *        # 每天凌晨 2:00
0 8,12,18 * * *  # 每天 8:00、12:00、18:00
30 8 * * *       # 每天早上 8:30
```

**每周**
```
0 2 * * 1        # 每周一凌晨 2:00
0 9 * * 1-5      # 工作日早上 9:00
0 0 * * 0        # 每周日零点
```

**每月**
```
0 2 1 * *        # 每月 1 号凌晨 2:00
0 2 1,15 * *     # 每月 1 号和 15 号凌晨 2:00
0 2 L * *        # 每月最后一天凌晨 2:00
```

**特殊间隔**
```
0 */2 * * *      # 每 2 小时
0 */4 * * *      # 每 4 小时
0 */6 * * *      # 每 6 小时
0 */12 * * *     # 每 12 小时
```

#### 定时任务最佳实践

1. **选择合适的执行时间**
   - 避开业务高峰期
   - 建议在凌晨 2-4 点执行
   - 考虑源 Registry 的时区

2. **控制执行频率**
   - 镜像更新不频繁：每天或每周执行
   - 关键业务镜像：每小时或每 6 小时
   - 避免过于频繁导致资源浪费

3. **错峰执行多个任务**
   ```
   任务 1: 0 2 * * *    # 凌晨 2:00
   任务 2: 0 3 * * *    # 凌晨 3:00
   任务 3: 0 4 * * *    # 凌晨 4:00
   ```

4. **监控执行结果**
   - 配置通知（建议"仅失败时发送"）
   - 定期检查执行历史
   - 关注失败任务并及时处理

#### 验证 Cron 表达式

可以使用在线工具验证 Cron 表达式：
- https://crontab.guru/
- https://crontab.cronhub.io/

---

## 常见问题

### Q1: 同步失败，提示 "401 Unauthorized"？

**原因**：Registry 认证失败

**解决方案**：
1. 检查用户名和密码是否正确
2. Docker Hub 建议使用 Personal Access Token
3. 确认账户有源仓库的读权限和目标仓库的写权限
4. 重新测试 Registry 连接

---

### Q2: 提示 "blob unknown to registry" 错误？

**原因**：多架构镜像的某些 blob 同步失败

**解决方案**：
1. 查看详细日志，找出失败的 blob
2. 检查网络连接是否稳定
3. 重新执行任务（系统会跳过已存在的 blob）
4. 如果持续失败，尝试只选择单个架构同步

---

### Q3: 同步速度很慢怎么办？

**原因**：网络带宽或 Registry 性能限制

**解决方案**：
1. 检查网络带宽是否充足
2. 选择网络延迟低的时段执行
3. 如果是 Docker Hub，检查是否被限流（429 错误）
4. 考虑使用 CDN 或镜像加速服务

---

### Q4: 定时任务没有执行？

**原因**：任务配置或系统状态问题

**排查步骤**：
1. 确认任务已启用（开关打开）
2. 检查 Cron 表达式是否正确
3. 查看执行历史是否有错误日志
4. 检查 Registry 配置是否有效
5. 重启服务后 Cron 会重新加载

---

### Q5: 如何查看正在运行的任务？

**操作步骤**：
1. 进入 **执行历史** 页面
2. 筛选状态为 **运行中**
3. 点击 **查看日志** 查看实时进度

**仪表盘显示**：
- 仪表盘会显示当前运行中的任务数量
- 点击卡片可快速跳转

---

### Q6: 可以停止正在运行的任务吗？

**可以**

**操作方法**：
1. 在任务列表或执行历史中找到任务
2. 点击 **停止** 按钮
3. 确认停止操作

**注意事项**：
- 已传输的 blob 不会回滚
- 停止后状态变为"失败"
- 可以重新运行任务，系统会跳过已同步的内容

---

### Q7: 忘记 Registry 密码怎么办？

**处理方法**：

1. **重新获取密码**
   - 从 Registry 管理后台重置密码
   - Docker Hub 可重新生成 Token

2. **更新配置**
   - 编辑 Registry 配置
   - 输入新密码
   - 测试连接
   - 保存配置

---

### Q8: 通知没有收到？

**排查步骤**：

1. **检查通知渠道配置**
   - 进入通知管理
   - 检查渠道是否启用
   - 点击"测试发送"验证配置

2. **检查任务通知配置**
   - 编辑任务
   - 确认已启用通知
   - 检查是否选择了正确的渠道
   - 检查通知条件设置

3. **检查企业微信/钉钉设置**
   - 确认机器人未被禁用
   - 检查 Webhook URL 是否正确
   - 钉钉检查关键词或签名配置

---

### Q9: 目标项目不存在会自动创建吗？

**不会**

**处理方法**：
1. 手动在目标 Registry 中创建项目
2. 确保项目名称与任务配置一致
3. 确认账户有项目的访问权限

**注意**：
- 仓库会自动创建
- 项目必须手动创建

---

### Q10: 如何批量同步多个仓库？

**方法 1：整个项目同步**
- 创建任务时不填写源仓库名
- 系统自动同步整个项目

**方法 2：创建多个任务**
- 为每个仓库创建单独的任务
- 可以设置不同的定时策略
- 独立监控每个任务的执行情况

---

## 最佳实践

### 1. Registry 配置

✅ **推荐做法**

- 为每个 Registry 创建专用的同步账户
- 使用描述性的名称（如：`Harbor 生产环境`、`Docker Hub 官方`）
- 定期更换密码或 Token
- 测试连接后再使用
- 使用最小权限原则（只授予必要的读写权限）

❌ **避免做法**

- 使用管理员账户进行同步
- 多个 Registry 使用相同名称
- 长期不更换密码
- 不测试连接就创建任务

---

### 2. 任务配置

✅ **推荐做法**

- 使用描述性的任务名称（如：`同步 Nginx 到生产环境`）
- 明确的 Tag 过滤规则，避免同步不需要的版本
- 只选择需要的架构，减少传输量
- 合理设置定时任务频率
- 配置失败通知，及时发现问题

❌ **避免做法**

- 模糊的任务名称（如：`任务1`、`test`）
- 不配置任何过滤规则，同步所有内容
- 过于频繁的定时任务（如每 5 分钟）
- 不配置通知，无法及时发现失败

---

### 3. Tag 过滤

✅ **推荐做法**

**生产环境**
```
包含：^[0-9]+\.[0-9]+\.[0-9]+$
排除：.*(beta|rc|alpha|dev).*
保留最新：10
```

**开发/测试环境**
```
包含：^(latest|develop|.*-beta)$
排除：（留空）
保留最新：5
```

**特定版本**
```
包含：^(latest|stable|1\.2[5-9]\..*)$
排除：（留空）
保留最新：0
```

❌ **避免做法**

- 不使用任何过滤，同步所有 Tag
- 正则表达式过于复杂，难以维护
- 保留最新 N 个设置过大（如 1000）

---

### 4. 定时任务

✅ **推荐做法**

**不同场景的建议频率**

| 场景 | 推荐频率 | Cron 表达式 |
|------|---------|------------|
| 生产关键镜像 | 每 6 小时 | `0 */6 * * *` |
| 一般生产镜像 | 每天一次 | `0 2 * * *` |
| 开发测试镜像 | 每周一次 | `0 2 * * 1` |
| 灾备同步 | 每天一次 | `0 3 * * *` |
| 合规归档 | 每月一次 | `0 2 1 * *` |

**时间选择**
- 选择业务低峰期（如凌晨 2-4 点）
- 错开多个任务的执行时间
- 考虑源 Registry 的维护窗口

❌ **避免做法**

- 所有任务在同一时间执行
- 在业务高峰期执行大量同步
- 频繁执行不常更新的镜像同步

---

### 5. 通知配置

✅ **推荐做法**

**一次性任务**
```
通知条件: 全部发送（成功+失败）
```

**定时任务（高频）**
```
通知条件: 仅失败时发送
```

**定时任务（低频）**
```
通知条件: 全部发送（成功+失败）
```

**多渠道配置**
- 生产任务：发送到运维群
- 测试任务：发送到开发群
- 关键任务：同时发送多个渠道

❌ **避免做法**

- 高频定时任务发送所有通知（消息刷屏）
- 不配置任何通知（无法及时发现问题）
- 所有任务发送到同一个群（信息混乱）

---

### 6. 监控和维护

✅ **推荐做法**

**日常检查**（每天）
- 查看仪表盘统计信息
- 检查是否有失败的任务
- 查看最近执行记录

**定期检查**（每周）
- 审查所有任务配置
- 清理不再使用的任务
- 检查 Registry 凭据是否有效
- 查看执行历史趋势

**月度维护**（每月）
- 更新 Registry 密码
- 优化 Tag 过滤规则
- 评估定时任务频率
- 清理旧的执行记录（如果需要）

❌ **避免做法**

- 从不查看执行历史
- 失败任务长期不处理
- Registry 凭据从不更新
- 任务配置创建后从不优化

---

### 7. 安全建议

✅ **推荐做法**

1. **账户安全**
   - 使用专用同步账户
   - 使用强密码
   - 定期轮换密码
   - Docker Hub 使用 Token 而非密码

2. **权限控制**
   - 最小权限原则
   - 源仓库只需读权限
   - 目标仓库只授予必要的项目写权限

3. **网络安全**
   - 生产环境使用 HTTPS
   - 内网部署时配置防火墙
   - 使用 VPN 或专线连接跨云 Registry

4. **数据保护**
   - 定期备份数据库文件
   - 限制数据库文件访问权限
   - 日志不要包含敏感信息

❌ **避免做法**

- 使用管理员账户
- 授予过多权限
- 在公网明文传输（HTTP）
- 不备份配置数据

---

### 8. 故障处理

**同步失败**

1. 查看详细日志，确定失败原因
2. 检查网络连接
3. 验证 Registry 凭据
4. 重新执行任务

**性能问题**

1. 检查网络带宽
2. 优化 Tag 过滤规则，减少同步量
3. 调整定时任务到低峰期
4. 考虑分批次同步

**存储空间不足**

1. 清理不需要的执行历史
2. 优化 Tag 过滤，只保留必要版本
3. 扩展数据库存储空间

---

## 总结

通过本手册，您应该已经掌握了 Registry Sync 的所有基本功能和高级特性。如果在使用过程中遇到问题：

1. 先查阅本手册的"常见问题"部分
2. 查看系统的详细日志
3. 联系系统管理员或技术支持

祝您使用愉快！

---

**文档版本**：v0.0.1
**最后更新**：2025-11-27
